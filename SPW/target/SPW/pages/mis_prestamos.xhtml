<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:components="http://xmlns.jcp.org/jsf/composite/components"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&amp;display=swap" rel="stylesheet"/>

    <style>

        .tarjeta {
            font-family: 'Varela Round', sans-serif;
            display: flex;
            flex-wrap: wrap;
            width: 240px;
            height: 370px;
            padding: 7px;
            border-radius: 10px;   
            background-color: white;
            box-shadow: rgba(60, 64, 67, 0.3) 0px 1px 2px 0px, rgba(60, 64, 67, 0.15) 0px 2px 6px 2px;
        }

        .image {
            width: 100%;
            height: 100%;
        }

        .detalle {           
            display: flex;
            flex-wrap: wrap;
            overflow: hidden;            
            border-radius: 10px;
            width: 100%;
            height: 150px;
        }

        .padless {
            padding: 0px;
        }

        .padSet {
            display: flex;
            align-items: center;
            padding-bottom: 20px;
        }

        .head {
            padding: 0px;
        }

        .titulo {
            font-family: 'Varela Round', sans-serif;
            font-weight: bold;
            height: 35px;
            margin-top: 15px;
            margin-bottom: 0px;
            font-size: 1.2em;
        }

        .newForm {
            font-family: 'Varela Round', sans-serif;
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 20px;
            width: 100%;
            border-radius: 10px;   
            background-color: white;
            box-shadow: rgba(60, 64, 67, 0.3) 0px 1px 1px 0px, 
                rgba(60, 64, 67, 0.15) 1.5px 1.5px 3px 1px;
        }

        .titulo2 {
            font-family: 'Varela Round', sans-serif;
            font-weight: bold;
            font-size: 1.5em;
            margin: 0px
        }


        .search {
            width: 100%; 
            display: flex; 
            float: right;
            margin-top: 4px;
            border-radius: 10px;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 5px 5px -5px, rgba(0, 0, 0, 0.04) 8px 5px 5px -5px;
        }

        .texto {
            margin-bottom: 10px;
            margin-top: 10px;
            font-size: 1.1em;
            color: #3f4c51;
        }

        .fechaP {
            color: #ffbe0b;
        }

        .cel {
            color: #3a86ff;
        }

        .boton {
            font-family: 'Varela Round', sans-serif;
            text-align: center;
            width: 100%;
            margin-bottom: 15px;
            padding: 1em 1.5em;
            background-color: #0077b6;
            text-decoration: none;
            color: white;
            border-radius: 10px;
            box-shadow: rgba(0, 0, 0, 0.30) 0px 5px 8px;
        }

        .fas {
            display: none;
        }

        .boton:hover{
            color: white;
        }

        .flexDisplay {
            display: flex;
            flex-wrap: wrap;
        }

        .peso {
            font-weight: bold;
            display: none;
        }
        

        @media(max-width: 767px) {
            
            .tableText {
                font-size: 0.7em;
            }

            .tarjeta {
                width: 100%;
                height: auto;
            }

        }



    </style>    
    
    
    <h:form id="formMisPrestamos" class="form-horizontal">
        <p:focus for="buscar" context="formMisPrestamos"/>
        
        <div class="col-xs-12" >

            <div class="col-xs-12 head"  >
                <div class="newForm" >

                    <div class="col-xs-12 col-sm-3" >                   
                        <p class="titulo2" >
                            <img height="50" 
                                 style="margin-right: 10px; 
                                        margin-bottom: 10px;" 
                                 src="resources/images/loan.png" /> 
                            Mis Préstamos
                        </p>
                    </div>

                    <div class="col-xs-6 col-sm-2" style="padding-top: 15px; padding-bottom: 10px;" >
                        <p:outputLabel value="#{misPrestamosBean.updateViewText()}" 
                                       style="font-weight: 400;  
                                              margin-right: 5px; 
                                              margin-top: 2px; 
                                              vertical-align: top;"/>
                        <p:toggleSwitch value="#{misPrestamosBean.viewMode}" >
                            <p:ajax event="change" update="formMisPrestamos" />
                        </p:toggleSwitch>
                    </div>
                    
                    
                    <div class="col-xs-6 col-sm-3" style="padding-top: 15px; padding-bottom: 10px;" >
                        <p:outputLabel value="#{misPrestamosBean.updateOrderText()}" 
                                       style="font-weight: 400;  
                                              margin-right: 5px; 
                                              margin-top: 2px; 
                                              vertical-align: top;"/>
                        <p:toggleSwitch value="#{misPrestamosBean.orderMode}" >
                            <p:ajax event="change" 
                                    listener="#{misPrestamosBean.revertListAmortizacion()}" 
                                    update="formMisPrestamos" />
                        </p:toggleSwitch>
                    </div>

                    <div class="col-xs-12 col-sm-4" style="padding-top: 5px;" >
                        
                        
                        <p:remoteCommand name="test" 
                                         action="#{misPrestamosBean.updateListAmortizacion()}" 
                                         update="@([id$=formMisPrestamos])"/>
                        <p:inputText id="buscar" 
                                     onfocus="this.setSelectionRange(0, this.value.length)"
                                     value="#{misPrestamosBean.buscarPrestamo}"
                                     onkeypress="if (event.keyCode == 13) {
                                                 test();
                                                 return false;
                                             }"
                                     class="search"
                                     placeholder="Buscar por Nombre... Enter"/>

                    </div>
                </div>   
            </div>

            <!--Vista de tarjetas-->

            <p:repeat id="gridList" 
                      value="#{misPrestamosBean.listAmortizacion}" 
                      rendered="#{!misPrestamosBean.viewMode}" var="amor">

                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12 padSet" >
                    <div class="row" >
                        <div class="tarjeta" >
                            <div class="col-xs-12 padless flexDisplay" >
                                <div class="detalle" >
                                    <p:commandLink  update="formMisPrestamos principal"
                                                    action="#{misPrestamosBean.detailGridAmortizacionPrestamo()}"
                                                    actionListener="#{misPrestamosBean.setAmortizacionGridSeleccionada(amor)}" >
                                        
                                        <p:graphicImage value="#{misPrestamosBean.downloadFile(amor.idPrestamo.idPersona.fotoCedula)}" 
                                                        stream="false"
                                                        class="image" /> 
                                    </p:commandLink>
                                </div>
                            </div>


                            <div class="col-xs-12" >
                                <div class="row" >
                                    <div class="col-sm-12" >
                                        <h4 class="titulo">#{amor.idPrestamo.idPersona.nombre}</h4>
                                    </div>

                                    <div class="col-sm-12 texto" style="padding-top: 5px;" >
                                        <div class="col-xs-12 padless" >
                                            <p>Cel: <span class="cel">#{amor.idPrestamo.idPersona.celular}</span></p>
                                        </div>
                                        <div class="col-xs-12 padless " style="padding-bottom: 10px;">
                                            <p>Pago: <span style="color: #{misPrestamosBean.getDateColor(amor)}" 
                                                           class="fechaP" >#{misPrestamosBean.formatDate(amor.fecha)}</span></p>
                                        </div>                   
                                    </div>     
                                </div>
                            </div>

                            <div class="col-xs-12 padless contBoton flexDisplay" >
                                <p:commandLink class="boton"
                                               style="background-color: #{misPrestamosBean.getDateColor(amor)};"
                                               action="#{misPrestamosBean.fillFormPagar()}"
                                               actionListener="#{misPrestamosBean.setAmortizacionGeneralSeleccionada(amor)}"
                                               update="@([id$=formPagar])"
                                               onclick="PF('r_pago').show();">             
                                    <!--<i class="fas fa fa-usd"></i>-->
                                    <h3 class="peso" >$</h3>
                                    <b class="cuota" style="font-size: 1em;">Cuota ##{amor.cuotaNum} - RD$. #{misPrestamosBean.formatMoney(amor.cuota)}</b>
                                </p:commandLink>
                            </div>
                        </div>
                    </div>
                </div>

            </p:repeat>



            <!--Vista de tabla-->

            <div class="newForm" style="display: #{misPrestamosBean.displayMode}; background-image: none;" >

                <p:contextMenu for="tablaMisPrestamos" id="rmenu">

                    <p:menuitem value="Pagar"
                                action="#{misPrestamosBean.fillFormPagar()}"
                                update="tablaMisPrestamos @([id$=formPagar])"
                                onclick="PF('r_pago').show();"
                                icon="pi pi-dollar"/>

                    <p:menuitem value="Detalles"
                                update="principal"
                                action="#{navigationBean.showPrestamo()}"
                                actionListener="#{misPrestamosBean.detailTableAmortizacionPrestamo()}"
                                disabled="#{!misPrestamosBean.rowSelected}"
                                icon="pi pi-folder-open"/>

                    <p:menuitem value="Columnas"                  
                                update="@([id$=editColumna])"                                  
                                onclick="PF('dialogColumnas').show();"
                                actionListener="#{misPrestamosBean.fillCheckListColumnas()}"
                                icon="pi pi-table"/>
                </p:contextMenu>
                
                <p:dataTable var="amort"
                             tableStyleClass="tableText"
                             id="tablaMisPrestamos"
                             value="#{misPrestamosBean.listAmortizacion}"
                             emptyMessage="No hay registros que mostrar" 
                             selectionMode="single"
                             selection="#{misPrestamosBean.amortizacionTableSeleccionada}"
                             rowKey="#{amort.idPago}"
                             style="text-align: center; 
                             font-size: 1.2em;" 
                             reflow="false">

                    <p:ajax update="@([id$=rmenu])" event="rowSelect"  />

                    <p:column headerText="Cédula" 
                              visible="#{misPrestamosBean.foto_cedula}"
                              responsivePriority="5">
                        <p:graphicImage id="imgCedula"
                                        style="border-radius: 5px;"
                                        value="#{misPrestamosBean.downloadFile(amort.idPrestamo.idPersona.fotoCedula)}" 
                                        stream="false"
                                        width="100%"/>    
                    </p:column>       
                    <!--filterBy="# {amort.idPrestamo.idPersona.nombre}" filterMatchMode="contains"-->
                    <p:column headerText="Nombre" visible="#{misPrestamosBean.nombre}" >
                        <h:outputText value="#{amort.idPrestamo.idPersona.nombre}" />                            
                    </p:column>

                    <p:column headerText="Cuota No." visible="#{misPrestamosBean.cuota_num}" >
                        <h:outputText value="#{amort.cuotaNum}" />
                    </p:column>

                    <p:column headerText="Pago Capital" 
                              visible="#{misPrestamosBean.pago_capital}"
                              responsivePriority="3">
                        <h:outputText value="#{misPrestamosBean.formatMoney(amort.pagoCapital)}" />
                    </p:column>

                    <p:column headerText="Pago Interés" 
                              visible="#{misPrestamosBean.pago_interes}"
                              responsivePriority="3">
                        <h:outputText value="#{misPrestamosBean.formatMoney(amort.pagoInteres)}" />
                    </p:column>

                    <p:column headerText="Cuota" 
                              visible="#{misPrestamosBean.cuota}"
                              width="80">
                        <h:outputText value="#{misPrestamosBean.formatMoney(amort.cuota)}" />
                    </p:column>

                    <p:column headerText="Saldo" 
                              visible="#{misPrestamosBean.saldo}" 
                              responsivePriority="5">
                        <h:outputText value="#{misPrestamosBean.formatMoney(amort.saldo)}" />
                    </p:column>

                    <p:column headerText="Fecha Pago" 
                              visible="#{misPrestamosBean.fecha}" >
                        <h:outputText style="color: #{misPrestamosBean.getDateColor(amort)}" 
                                      value="#{misPrestamosBean.formatDate(amort.fecha)}" />
                    </p:column>

                    <p:column headerText="Estado" 
                              visible="#{misPrestamosBean.estado}" 
                              responsivePriority="6" >
                        <h:outputText value="#{amort.estado}" />
                    </p:column>

                    <f:facet name="footer">Cantidad de registros: [ #{misPrestamosBean.listAmortizacion.size()} ]</f:facet>
                </p:dataTable>

                
            </div>
        </div>
    </h:form>

    <components:dialogPagar nombreCliente="#{misPrestamosBean.nombreCliente}"
                            totalCapital="#{misPrestamosBean.totalCapital}"
                            totalInteres="#{misPrestamosBean.totalInteres}"
                            totalCargoMora="#{misPrestamosBean.totalCargoMora}"
                            totalCuota="#{misPrestamosBean.totalCuota}"
                            pagoCapital="#{misPrestamosBean.capital}" 
                            pagoInteres="#{misPrestamosBean.interes}" 
                            cargoMora="#{misPrestamosBean.cargoMora}"
                            cuotaNum="#{misPrestamosBean.cuotaNum}"
                            balancePendiente="#{misPrestamosBean.balancePendiente}"
                            reCalcPago="#{misPrestamosBean.reCalcPago()}"
                            checkDisable="#{misPrestamosBean.checkDisable}"
                            checkBoxChanges="#{misPrestamosBean.checkBoxChanges}"
                            checkAll="#{misPrestamosBean.checkAll()}"
                            savePago="#{misPrestamosBean.savePago()}"
                            listPagos="#{misPrestamosBean.listPago}"
                            reiniciar="#{misPrestamosBean.fillFormPagar()}"
                            addPagoToList="#{misPrestamosBean.addPagoToList()}"
                            updateElement="@([id$=formMisPrestamos])"/>

    <components:dialogColumnas listColumna="#{misPrestamosBean.listColumna}"
                               listCheckColumna="#{misPrestamosBean.listCheckColumna}"
                               save="#{misPrestamosBean.updateCheckListColumna()}"
                               updateElement="@([id$=tablaMisPrestamos])"/>

</ui:composition>


